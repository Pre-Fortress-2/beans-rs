# Server-Side Integration

`beans-rs` relies on Server-Side Integration to keep players up to date with the latest versions of Sourcemods. By utilizing a combination of free software and a few configuration files, Sourcemod developers can quickly deploy updates for either singleplayer or multiplayer experiences.

## appvar.json

In the `src` folder there is a file called `appvar.json` which determines the currently targeted Sourcemod. By default it will be configured for [Open Fortress](https://openfortress.fun), but it can be modified to support any mod.

```json
{
  "mod": {
    "sm_name": "open_fortress",
    "short_name": "of",
    "name_stylized": "Open Fortress"
  },
  "remote": {
    "base_url": "https://of-proxy.kate.pet/",
    "versions_url": "https://of-proxy.kate.pet/versions.json"
  }
}
```

- `sm_name`: The folder name of the sourcemod (e.g. open_fortress, pf2, tf2classic, tf_coop_extended).
- `short_name`: This is the shorthand name used when identifying diff files from the static file server associated with the `beans-rs` instance (e.g. of-20to21.pwr, pf2-73to74.pwr).
- `name_stylized`: The full name of the mod.
- `base_url`: The file server address where the `beans-rs` related files will be stored. **Do not forget to include `/` at the end of the link.**
- `versions_url`: The file server address where the `versions.json` file will be stored.

## beans-rs

To start using `beans-rs`, there must be a matching static file server hosted by the Sourcemod developer. The static file server will host a combination of archive, diff, and  signature files. In charge of all of them is a file called `versions.json` and by carefully following these instructions, integrating `beans-rs` with any mod should be a simple process. `beans-rs` relies on [butler](https://itch.io/docs/butler) to generate signatures and diffs used in this process.

### Versions Variables

In `versions.json` there are numerous variables that relate to different components of an update.

- `signature`: The `.sig` file generated by butler when creating a signature of a build.
- `heal`: The "heal" zip file is an archive of the game's contents that is used by butler.
- `file`: This is a `tar.zst` archive of the game used by `beans-rs` when making a fresh install.
- `url`: This is the torrent file related to a download, if your game is not available via torrent then just reuse the `file` entry data.
- `presz`: "Pre-Size" is the size of the `file` component in bytes.
- `postsz`: "Post-Size" is the file of the contents of `file` component in bytes after extraction.
- `tempreq`: The size required to temporarily store the `file` patch.

### Versions File Formatting

Here is an example of how to format a `versions.json` file. 

This example will be based off the [versions.json](https://beans.adastral.net/versions.json) file hosted by [Open Fortress](https://openfortress.fun).

```json
{
    "versions":
    {
        "15": {
                "signature": "of-15.sig",
                "heal": "of-15-heal.zip"
        },
        "20": {
                "url": "of-20.torrent",
                "file": "of-20.tar.zstd",
                "presz": 5050680575,
                "postsz": 13884901888,
                "signature": "of-20.sig",
                "heal": "of-20-heal.zip"
        },
        "21": {
                "url": "of-21.torrent",
                "file": "of-21.tar.zstd",
                "presz": 5050680575,
                "postsz": 13884901888,
                "signature": "of-21.sig",
                "heal": "of-21-heal.zip"
        }
    },
    "patches":
    {
           
        "15": {
                "url": "of-15to21.torrent",
                "file": "of-15to21.pwr",
                "tempreq": 7500000000
        },
        "20": {
                "url": "of-20to21.torrent",
                "file": "of-20to21.pwr",
                "tempreq": 7500000000
         }
    }
}
```

In both `versions` and `patches` there is a numbered string entry for each version. It's important to stick to whole numbers when creating a new entry (e.g. 100, 201, 23, 60).

The `versions` section is the data related to downloadable versions. `beans-rs` will always default to the latest version number. For Open Fortress Revision 15 (written as `15` in the entry), there is no `file`, `presz`, or `postsz` entry as Revision 15 can only be upgraded from. In other games that use the [`MAJOR.MINOR.PATCH` system](https://semver.org/), the version number **must** be converted to the closest whole number. For instance `0.7.4` as `74` or `2.2.3` as `223`.

In the `patches` section, there is only a `url`, `file` and `tempreq` entry. The `.pwr` file is a diff generated by [butler](https://itch.io/docs/butler) and is used to upgrade the user to the latest version. As of `beans-rs` version 1.7.3, the `url` component is not yet optional and if the mod is not available via torrent, the `url` component should contain the same information as `file`.

## butler

Install butler based off the instructions on the [itch.io docs](https://itch.io/docs/butler/installing.html).

```sh
curl -L -o butler.zip https://broth.itch.ovh/butler/linux-amd64/LATEST/archive/default
unzip butler.zip
chmod +x butler
```

> [!IMPORTANT]
> ### Read before generating diffs or signatures
> Please make sure that your game files are organized as such:
> - `[version number]/[game shorthand name]`
>
> For example:
> - `of-21/open_fortress`
> - `pf2-74/pf2`

### Creating Heal Zips

The `-heal.zip` archive contains all of the contents of the `game` folder.

```sh
cd of-21/open_fortress
zip -r9 ../../of-21-heal.zip .
```

The heal zip must be an archive of the inside of the `game` folder or else it will create conflicts when generating diffs and signature. 

### Creating Tar Zstd

The `.tar.zst` archive contains the `game` folder.
```sh
cd of-21
tar --zstd -cvf ../of-21.tar.zst open_fortress
```

It's important for the Tar to be made of the game folder itself and not the contents. The Tar file will be used for fresh installs of your game and will be directly extracted to the `sourcemods` folder.

### Generating a Diff with Signatures

This section will generate a `.pwr` diff file and a `.pwr.sig` signature file which will be stored together in the file server. 

```sh
./butler diff --assume-yes of-20-heal.zip of-21-heal.zip of-20to21.pwr
```

When creating the diff file it is important to match this file structure: `of-20to21.pwr` or `[game]-[old version]to[latest version].pwr`.

The first heal zip is the version you're upgrading from and the second one should be the latest. `butler` automatically makes a diff based on the contents of the heal zip, this is why it's important to make the heal zips based of the contents of a `game` folder rather than of the `game` folder itself.

## Generating Build Signatures

Creating a signature of a build can be done by selecting the heal zip of the version.

```sh
./butler sign of-21-heal.zip of-21-heal.zip.sig
```

This will be used for verifying the integrity of the files when updating.

## Iterating Versions

When your `sourcemod` receives a new update it's a simple process to generate new `.pwr` files to the new latest version.

Generate the `-heal.zip` and `.tar.zst` file for the new latest version and then replace the old `.pwr` and `.pwr.sig` files by running the diff command with the new latest version. Make sure to update the remote `versions.json` file to reflect the new diff and heal zips. `beans-rs` will always stay coordinated with the server so long as the `verion.json` file is maintained and the new update files are present on the static file server.